# Web Package

React PWA that displays Warhammer 40K data generated by the CLI. The app is offline-first (IndexedDB cache) and ships via Vite.

## Key Commands

```bash
# Start the PWA locally (expects data already copied to public/data)
pnpm --filter @depot/web dev

# Run the full experience (builds core+cli, generates data, copies assets, then starts dev server)
pnpm start

# Production build
pnpm --filter @depot/web build

# Preview production build
pnpm --filter @depot/web preview

# Run tests
pnpm --filter @depot/web test

# Run tests in CI mode
pnpm --filter @depot/web test:ci

# Format code
pnpm --filter @depot/web format

# Lint code
pnpm --filter @depot/web lint

# Type check
pnpm --filter @depot/web typecheck

# Clean dist folder
pnpm --filter @depot/web clean

# Generate PWA assets
pnpm --filter @depot/web generate-pwa-assets
```

## Technology Stack

- **React 19** + React Router DOM v7
- **Context + useReducer** for state management
- **IndexedDB** for offline-first data storage
- **Tailwind CSS v4** for styling
- **Vite 6** for build tooling
- **Vitest** + React Testing Library for testing

### Styling Guidelines
- Tailwind utilities are centralized in `src/styles/main.css`; prefer semantic helpers (`text-foreground`, `text-body`, `surface-card`, etc.) over raw color classes.
- Status palette helpers are available for info/success/warning/danger states (`text-info[-strong]`, `surface-success[-strong]`, `border-warning`, `focus-ring-danger`, ...). Reuse these before introducing new colour combos.
- When a layout/color/focus trio repeats twice, promote it to an `@utility` entry so JSX stays concise and align with the design system.
- Group tailwind classes structural → colour → interaction to keep merges predictable and consistent with existing components.

## Key Routes

- `/` - Home dashboard
- `/factions` - Browse all factions
- `/faction/:factionSlug` - Faction overview
- `/faction/:factionSlug/datasheet/:datasheetSlug` - Datasheet details
- `/rosters` - Saved roster list
- `/rosters/create` - Create roster wizard
- `/rosters/:rosterId` - Read-only roster view
- `/rosters/:rosterId/edit` - Roster editor
- `/rosters/:rosterId/add-units` - Datasheet picker for a roster
- `/rosters/:rosterId/units/:unitId/edit` - Unit loadout editor
- `/settings` - Application preferences
- `*` - Not Found fallback
- `/privacy`, `/about`, `/not-found` - static content routes

## Architecture

### State Management
- **App Context**: Global data, faction cache, settings
- **Layout Context**: UI state (sidebar, responsive)
- **Toast Context**: Notifications
- **Roster Context**: Roster building state

### Data Flow
1. **Fetch**: Load JSON files from `/public/data/` or network
2. **Cache**: Store in IndexedDB for offline access
3. **Context**: Global state management with React contexts
4. **Components**: Consume data through hooks and contexts

### Directory Structure
```
src/
├── components/          # Reusable UI components
│   ├── ui/             # Base UI library
│   └── shared/         # Domain-specific components
├── contexts/           # React contexts for state
├── routes/             # Route-aligned views + colocated logic
├── hooks/              # Custom React hooks
├── utils/              # Business logic utilities
├── data/               # IndexedDB and data utilities
├── constants/          # App constants
└── styles/             # Global styles
```

## Key Utilities

### `utils/`
- `abilities.ts` - Helpers for faction and datasheet ability display
- `array.ts` - Shared sorting utilities
- `datasheet.ts` - Datasheet grouping/filter helpers
- `faction.ts` - Faction filtering, grouping, and detachment helpers
- `keywords.ts` - Keyword labelling helpers
- `paths.ts` - App/data URL construction
- `roster.ts` - Roster formatting, export, and role grouping
- `wargear.ts` - Loadout parsing and default selection helpers

### `hooks/`
- `use-datasheet-browser.ts` - Shared search + filter state for datasheet lists
- `use-debounce.ts` - Generic debounce helper
- `use-faction.ts` - Single faction loader (context-backed)
- `use-factions.ts` - Faction index loader with caching
- `use-roster-unit-selection.ts` - Pending unit selection management
- `use-rosters.ts` - IndexedDB-backed roster CRUD
- `use-scroll-collapse.ts` - Sticky footer management for selection summary
- `use-select.ts` - Headless select control helper

### `routes/`
- `AGENTS.md` - Route conventions, nested layout, `_components` & `_utils` usage

### `data/`
- `offline-storage.ts` - IndexedDB data persistence layer

## Data Requirements

- `public/data/index.json` – Faction navigation index produced by `@depot/cli`
- `public/data/{factionSlug}.json` – Individual faction payloads consumed by the PWA
- Run `pnpm --filter @depot/cli start` (or a root `pnpm start`/`pnpm build`) when data needs to be regenerated

## Testing Notes
- Prefer targeted runs: `pnpm --filter @depot/web test -- src/routes/home/index.test.tsx`.
- All tests must wrap renders with `TestWrapper` (`src/test/test-utils.tsx`) to provide Router + contexts.
- When you add new UI primitives (e.g., cards/tiles), ensure there’s a matching story in tests to keep layout expectations locked in.
